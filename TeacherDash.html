<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard | EdTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Basic Setup */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #18181b; /* zinc-900 */
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modern Scrollbar for specific elements */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e4e4e7; border-radius: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a1a1aa; border-radius: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #71717a; }

        /* Simple Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.4s ease-out; }

        /* Page transition styles */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeInUp 0.5s ease; }

        /* Sidebar active state */
        .sidebar-nav li.active a, .sidebar-footer li.active a {
            background-color: #3f3f46; /* zinc-700 */
            color: white;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="text-zinc-300">

    <div class="flex h-screen">
        <aside class="w-64 bg-zinc-800 p-4 flex flex-col flex-shrink-0">
            <div class="sidebar-header flex items-center space-x-2 p-2 mb-6">
                <i data-lucide="book-marked" class="text-purple-400"></i>
                <span class="font-bold text-xl text-white">TeacherDash</span>
            </div>
            
            <div class="sidebar-profile text-center mb-6">
                <img id="teacher-avatar" src="https://i.pravatar.cc/60" alt="Teacher Avatar" class="rounded-full mx-auto mb-2">
                <h4 id="teacher-name" class="font-semibold text-white">Loading...</h4>
                <p id="teacher-designation" class="text-xs text-zinc-400">Loading...</p>
            </div>
            
            <nav class="sidebar-nav flex-grow">
                <ul class="space-y-2">
                    <li class="active"><a href="#" data-page="dashboard" class="flex items-center space-x-3 p-2 hover:bg-zinc-700/50 rounded-lg transition-colors duration-200"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a></li>
                    <li><a href="#" data-page="manage-content" class="flex items-center space-x-3 p-2 hover:bg-zinc-700/50 rounded-lg transition-colors duration-200"><i data-lucide="folder-kanban"></i><span>Manage Content</span></a></li>
                    <li><a href="#" data-page="study-rooms" class="flex items-center space-x-3 p-2 hover:bg-zinc-700/50 rounded-lg transition-colors duration-200"><i data-lucide="door-open"></i><span>Study Rooms</span></a></li>
                    <li><a href="#" data-page="student-progress" class="flex items-center space-x-3 p-2 hover:bg-zinc-700/50 rounded-lg transition-colors duration-200"><i data-lucide="users"></i><span>Student Progress</span></a></li>
                    <li><a href="#" data-page="feedback-reports" class="flex items-center space-x-3 p-2 hover:bg-zinc-700/50 rounded-lg transition-colors duration-200"><i data-lucide="message-square-quote"></i><span>Feedback & Reports</span></a></li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <ul>
                    <li><a href="#" data-page="settings" class="flex items-center space-x-3 p-2 hover:bg-zinc-700/50 rounded-lg transition-colors duration-200"><i data-lucide="settings"></i><span>Settings</span></a></li>
                </ul>
            </div>
        </aside>

        <div class="main-content flex-grow overflow-y-auto no-scrollbar">
            <header class="bg-zinc-900 px-8 py-4 sticky top-0 z-10">
                <div class="flex items-center justify-between">
                    <div class="relative flex-1 max-w-xl">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none"><i data-lucide="search" class="h-5 w-5 text-zinc-400"></i></div>
                        <input type="text" class="w-full pl-12 pr-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Search students, content, or reports...">
                    </div>
                    <div class="flex items-center space-x-4 ml-6">
                        <button class="relative p-2 text-zinc-300 hover:bg-zinc-700 rounded-lg transition-colors"><i data-lucide="bell" class="h-6 w-6"></i><span class="absolute top-0 right-0 h-5 w-5 flex items-center justify-center bg-pink-500 text-white text-xs font-bold rounded-full transform -translate-y-1 translate-x-1">3</span></button>
                        <button class="flex items-center space-x-3 p-1 hover:bg-zinc-700 rounded-lg cursor-pointer transition-colors"><img id="header-avatar" src="https://i.pravatar.cc/40" alt="Teacher Avatar" class="h-9 w-9 rounded-full ring-2 ring-zinc-600"></button>
                    </div>
                </div>
            </header>

            <main id="dashboard" class="page-section active p-6">
                <div class="mb-6"><h1 class="text-3xl font-bold text-white">Welcome back, <span id="welcome-teacher-name">...</span>!</h1><p class="text-zinc-400">Here's a snapshot of your classroom activity.</p></div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-zinc-800 p-5 rounded-xl flex items-center"><div class="p-3 bg-blue-500/20 rounded-lg mr-4"><i data-lucide="users" class="text-blue-400"></i></div><div><p class="text-sm text-zinc-400">Total Students</p><p id="total-students" class="text-2xl font-semibold text-white">0</p></div></div>
                    <div class="bg-zinc-800 p-5 rounded-xl flex items-center"><div class="p-3 bg-purple-500/20 rounded-lg mr-4"><i data-lucide="trending-up" class="text-purple-400"></i></div><div><p class="text-sm text-zinc-400">Average Progress</p><p class="text-2xl font-semibold text-white">72%</p></div></div>
                    <div class="bg-zinc-800 p-5 rounded-xl flex items-center"><div class="p-3 bg-green-500/20 rounded-lg mr-4"><i data-lucide="user-check" class="text-green-400"></i></div><div><p class="text-sm text-zinc-400">Active Today</p><p class="text-2xl font-semibold text-white">28</p></div></div>
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-zinc-800 p-6 rounded-xl"><h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3><div class="space-y-3"><button id="upload-video-btn" class="w-full flex items-center p-3 bg-zinc-700/50 hover:bg-zinc-700 rounded-lg transition-colors"><i data-lucide="video" class="mr-3 h-5 w-5 text-blue-400"></i> <span class="text-white">Upload Video</span></button><button id="new-quiz-btn" class="w-full flex items-center p-3 bg-zinc-700/50 hover:bg-zinc-700 rounded-lg transition-colors"><i data-lucide="brain-circuit" class="mr-3 h-5 w-5 text-purple-400"></i> <span class="text-white">Create Quiz</span></button><button id="add-notes-btn" class="w-full flex items-center p-3 bg-zinc-700/50 hover:bg-zinc-700 rounded-lg transition-colors"><i data-lucide="book-copy" class="mr-3 h-5 w-5 text-green-400"></i> <span class="text-white">Add Notes</span></button><button id="start-live-btn" class="w-full flex items-center p-3 bg-zinc-700/50 hover:bg-zinc-700 rounded-lg transition-colors"><i data-lucide="radio" class="mr-3 h-5 w-5 text-red-400"></i> <span class="text-white">Start Live Lecture</span></button><button class="w-full flex items-center p-3 bg-zinc-700/50 hover:bg-zinc-700 rounded-lg transition-colors"><i data-lucide="puzzle" class="mr-3 h-5 w-5 text-amber-400"></i> <span class="text-white">New Assignment</span></button></div></div>
                        <div class="bg-zinc-800 p-6 rounded-xl"><h3>Student Alerts</h3>...</div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-zinc-800 p-6 rounded-xl"><h3 class="text-lg font-semibold text-white mb-4">Weekly Activity</h3><div class="h-64 bg-zinc-700/50 rounded-lg flex items-center justify-center text-zinc-400">[Chart placeholder]</div></div>
                        <div class="bg-zinc-800 p-6 rounded-xl"><h3>Leaderboard Snapshot</h3>...</div>
                    </div>
                </div>
            </main>
            
            <main id="manage-content" class="page-section p-6">
                <div class="flex justify-between items-center mb-6"><div><h1 class="text-3xl font-bold text-white">Manage Content</h1><p class="text-zinc-400">View and manage all your created quizzes.</p></div></div>
                <div id="manage-quizzes-container" class="bg-zinc-800 rounded-xl overflow-hidden">
                    <p class="text-zinc-400 p-8 text-center">Loading quizzes...</p>
                </div>
            </main>

            <main id="study-rooms" class="page-section p-6">
                <!-- All your Study Rooms HTML is here -->
            </main>

            <main id="student-progress" class="page-section p-6">
                <div class="mb-6"><h1 class="text-3xl font-bold text-white">Student Progress</h1><p class="text-zinc-400">Track performance, view leaderboards, and generate reports.</p></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-zinc-800 rounded-xl p-4">
                        <table class="w-full text-left">
                            <thead class="border-b border-zinc-700"><tr class="text-sm font-semibold text-zinc-300"><th class="p-4">Student Name</th><th class="p-4">Overall Progress</th><th class="p-4">Last Active</th><th class="p-4"></th></tr></thead>
                            <tbody id="student-table-body" class="divide-y divide-zinc-700">
                                <!-- Student rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="lg:col-span-1 bg-zinc-800 rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Leaderboard</h3>
                        <div id="leaderboard-container">
                            <p class="text-zinc-400 text-center">Loading leaderboard...</p>
                        </div>
                    </div>
                </div>
            </main>

            <main id="feedback-reports" class="page-section p-6">
                <!-- All your Feedback & Reports HTML is here -->
            </main>

            <main id="settings" class="page-section p-6"><h1>Settings</h1></main>
        </div>
    </div>

    <!-- VIDEO UPLOAD MODAL -->
    <div id="video-upload-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col text-black">
            <div class="p-6 flex justify-between items-center border-b border-zinc-200 flex-shrink-0">
                <div><h2 class="text-2xl font-bold text-zinc-800">Upload Video</h2></div>
                <button id="close-video-modal" type="button" class="p-2 text-zinc-500 hover:bg-zinc-100 rounded-full"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <form id="video-upload-form" class="flex-grow overflow-y-auto custom-scrollbar p-6">
                <div class="space-y-4">
                    <div>
                        <label for="video-chapter" class="block text-sm font-medium text-zinc-700 mb-1">Chapter</label>
                        <input type="text" id="video-chapter" name="chapter" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="video-topic" class="block text-sm font-medium text-zinc-700 mb-1">Topic</label>
                        <input type="text" id="video-topic" name="topic" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="video-file" class="block text-sm font-medium text-zinc-700 mb-1">Video File</label>
                        <input type="file" id="video-file" name="video" accept="video/*" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                </div>
            </form>
            <div class="p-6 bg-zinc-50 border-t flex justify-end items-center rounded-b-2xl flex-shrink-0">
                <button type="submit" form="video-upload-form" class="px-5 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">Upload Video</button>
            </div>
        </div>
    </div>

    <!-- NOTES UPLOAD MODAL -->
    <div id="notes-upload-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col text-black">
            <div class="p-6 flex justify-between items-center border-b border-zinc-200 flex-shrink-0">
                <div><h2 class="text-2xl font-bold text-zinc-800">Upload Notes</h2></div>
                <button id="close-notes-modal" type="button" class="p-2 text-zinc-500 hover:bg-zinc-100 rounded-full"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <form id="notes-upload-form" class="flex-grow overflow-y-auto custom-scrollbar p-6">
                <div class="space-y-4">
                    <div>
                        <label for="notes-chapter" class="block text-sm font-medium text-zinc-700 mb-1">Chapter</label>
                        <input type="text" id="notes-chapter" name="chapter" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="notes-topic" class="block text-sm font-medium text-zinc-700 mb-1">Topic</label>
                        <input type="text" id="notes-topic" name="topic" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="notes-file" class="block text-sm font-medium text-zinc-700 mb-1">Notes File</label>
                        <input type="file" id="notes-file" name="notes" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                </div>
            </form>
            <div class="p-6 bg-zinc-50 border-t flex justify-end items-center rounded-b-2xl flex-shrink-0">
                <button type="submit" form="notes-upload-form" class="px-5 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">Upload Notes</button>
            </div>
        </div>
    </div>

    <!-- UPDATED QUIZ MODAL with Time and Correct Answer Inputs -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col text-black">
            <div class="p-6 flex justify-between items-center border-b border-zinc-200 flex-shrink-0"><div><h2 class="text-2xl font-bold text-zinc-800">Create New Quiz</h2><p id="wizard-step-indicator" class="text-sm text-zinc-500">Step 1</p></div><button id="close-quiz-modal" type="button" class="p-2 text-zinc-500 hover:bg-zinc-100 rounded-full"><i data-lucide="x" class="h-5 w-5"></i></button></div>
            <form id="quiz-form" class="flex-grow overflow-y-auto custom-scrollbar">
                <div class="p-8">
                    <div id="wizard-step-1" class="wizard-step">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="quiz-title" class="block text-sm font-medium text-zinc-700 mb-1">Quiz Title</label><input type="text" id="quiz-title" name="title" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"></div>
                            <div><label for="quiz-subject" class="block text-sm font-medium text-zinc-700 mb-1">Subject</label><select id="quiz-subject" name="subject" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"><option value="">Select Subject</option><option>Mathematics</option><option>Physics</option><option>Chemistry</option></select></div>
                            <div class="md:col-span-2 grid grid-cols-2 gap-6">
                                <div><label for="quiz-start-time" class="block text-sm font-medium text-zinc-700 mb-1">Start Time (Optional)</label><input type="datetime-local" id="quiz-start-time" name="startTime" class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"></div>
                                <div><label for="quiz-end-time" class="block text-sm font-medium text-zinc-700 mb-1">End Time (Optional)</label><input type="datetime-local" id="quiz-end-time" name="endTime" class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"></div>
                            </div>
                        </div>
                    </div>
                    <div id="wizard-step-2" class="wizard-step hidden">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-semibold text-zinc-800">Quiz Questions</h3><button type="button" id="add-question-btn" class="flex items-center text-sm font-medium text-purple-600 hover:text-purple-800"><i data-lucide="plus-circle" class="h-4 w-4 mr-1"></i> Add Question</button></div>
                        <div id="questions-container" class="space-y-6"></div>
                        <div id="no-questions" class="text-center py-10 border-2 border-dashed rounded-lg"><p>No questions added yet.</p></div>
                    </div>
                    <div id="wizard-step-3" class="wizard-step hidden">
                        <h3 class="font-semibold text-zinc-800 mb-4">Review Your Quiz</h3><div id="quiz-review-area" class="bg-zinc-50 p-4 rounded-lg border"></div>
                    </div>
                </div>
            </form>
            <div class="p-6 bg-zinc-50 border-t flex justify-between items-center rounded-b-2xl flex-shrink-0"><button type="button" id="wizard-prev-btn" class="px-4 py-2 text-sm font-medium text-zinc-600 hover:bg-zinc-200 rounded-lg transition-colors hidden">Back</button><div class="flex-grow"></div><button type="button" id="wizard-next-btn" class="px-5 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">Next</button><button type="submit" form="quiz-form" id="wizard-submit-btn" class="px-5 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors hidden">Create Quiz</button></div>
        </div>
    </div>

    <!-- LIVE LECTURE MODAL -->
    <div id="live-lecture-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col text-black">
            <div class="p-6 flex justify-between items-center border-b border-zinc-200 flex-shrink-0">
                <div><h2 class="text-2xl font-bold text-zinc-800">Start Live Lecture</h2></div>
                <button id="close-live-modal" type="button" class="p-2 text-zinc-500 hover:bg-zinc-100 rounded-full"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <form id="live-lecture-form" class="flex-grow overflow-y-auto custom-scrollbar p-6">
                <div class="space-y-4">
                    <div>
                        <label for="lecture-topic" class="block text-sm font-medium text-zinc-700 mb-1">Topic</label>
                        <input type="text" id="lecture-topic" name="topic" required class="w-full border-zinc-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                </div>
            </form>
            <div class="p-6 bg-zinc-50 border-t flex justify-end items-center rounded-b-2xl flex-shrink-0">
                <button type="submit" form="live-lecture-form" class="px-5 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">Start Lecture</button>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // ===================================
        // DYNAMIC DATA FETCHING & UI POPULATION
        // ===================================
        const API_BASE_URL = 'http://localhost:3000';
        const teacherId = localStorage.getItem('currentUserId');
        const userRole = localStorage.getItem('currentUserRole');

        if (!teacherId || userRole !== 'teacher') {
            alert('Please log in as a teacher to continue.');
            window.location.href = './index.html';
            return;
        }

        lucide.createIcons();
        
        async function loadInitialData() {
            try {
                const teacherResponse = await fetch(`${API_BASE_URL}/api/teachers/${teacherId}`);
                if (!teacherResponse.ok) throw new Error('Could not fetch teacher data.');
                const teacherData = await teacherResponse.json();
                populateTeacherUI(teacherData);

                const studentsResponse = await fetch(`${API_BASE_URL}/api/teachers/${teacherId}/students`);
                if (!studentsResponse.ok) throw new Error('Could not fetch students.');
                const studentsData = await studentsResponse.json();
                populateStudentsTable(studentsData);
                
                document.getElementById('total-students').textContent = studentsData.length;

                loadManageableQuizzes();
                loadLeaderboard();
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                document.getElementById('teacher-name').textContent = 'Error';
            }
        }
        
        function populateTeacherUI(data) {
            const firstName = data.name.split(' ')[0];
            const avatarUrl = `https://i.pravatar.cc/60?u=${data.id}`;
            document.getElementById('teacher-name').textContent = data.name;
            document.getElementById('welcome-teacher-name').textContent = firstName;
            document.getElementById('teacher-designation').textContent = `${data.designation} (${data.subject})`;
            document.getElementById('teacher-avatar').src = avatarUrl;
            document.getElementById('header-avatar').src = avatarUrl.replace('60', '40');
        }

        function populateStudentsTable(students) {
            const tableBody = document.getElementById('student-table-body');
            tableBody.innerHTML = '';
            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-zinc-400">No students are assigned to you yet.</td></tr>';
                return;
            }
            students.forEach(student => {
                const progress = Math.floor(Math.random() * 60) + 40;
                const progressColor = progress > 80 ? 'bg-green-500' : progress > 60 ? 'bg-yellow-500' : 'bg-red-500';
                const row = `<tr class="fade-in-up"><td class="p-4 font-medium text-white flex items-center"><img src="https://i.pravatar.cc/32?u=${student.id}" class="h-8 w-8 rounded-full mr-3" alt="">${student.name}</td><td class="p-4"><div class="w-full bg-zinc-700 rounded-full h-2.5"><div class="${progressColor} h-2.5 rounded-full" style="width: ${progress}%"></div></div></td><td class="p-4">${Math.floor(Math.random() * 5) + 1} hours ago</td><td class="p-4"><button class="px-3 py-1 text-sm font-semibold bg-zinc-700 hover:bg-zinc-600 rounded-md">View Report</button></td></tr>`;
                tableBody.innerHTML += row;
            });
        }

        async function loadManageableQuizzes() {
             try {
                const response = await fetch(`${API_BASE_URL}/api/quizzes/all`);
                if (!response.ok) throw new Error('Could not fetch quizzes for management.');
                const allQuizzes = await response.json();
                
                const container = document.getElementById('manage-quizzes-container');
                container.innerHTML = '';
                
                if (allQuizzes.length === 0) {
                    container.innerHTML = '<p class="text-zinc-400 p-8 text-center">You have not created any quizzes yet.</p>';
                    return;
                }
                
                const table = document.createElement('table');
                table.className = 'w-full text-left';
                table.innerHTML = `<thead class="bg-zinc-700/50"><tr class="text-sm font-semibold text-zinc-300"><th class="p-4">Title</th><th class="p-4">Attempts</th><th class="p-4">Avg. Score</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr></thead><tbody class="divide-y divide-zinc-700"></tbody>`;
                const tbody = table.querySelector('tbody');

                allQuizzes.forEach(quiz => {
                    const now = new Date();
                    const startTime = quiz.startTime ? new Date(quiz.startTime) : null;
                    const endTime = quiz.endTime ? new Date(quiz.endTime) : null;
                    let status, statusColor;

                    if (!quiz.isActive) {
                        status = 'Ended'; statusColor = 'bg-red-500/20 text-red-300';
                    } else if (startTime && startTime > now) {
                        status = 'Scheduled'; statusColor = 'bg-blue-500/20 text-blue-300';
                    } else if (endTime && endTime < now) {
                        status = 'Expired'; statusColor = 'bg-zinc-500/20 text-zinc-300';
                    } else {
                        status = 'Active'; statusColor = 'bg-green-500/20 text-green-300';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-4 font-medium text-white">${quiz.title}</td>
                        <td class="p-4 text-zinc-300">${quiz.attempts}</td>
                        <td class="p-4 text-zinc-300">${quiz.averageScore.toFixed(1)} pts</td>
                        <td class="p-4"><span class="px-2 py-1 text-xs font-medium ${statusColor} rounded-full">${status}</span></td>
                        <td class="p-4 flex justify-end space-x-2">
                            ${(quiz.isActive && (!startTime || startTime <= now)) ? `<button data-quiz-id="${quiz.id}" class="end-quiz-btn p-2 hover:bg-zinc-700 rounded-md text-yellow-400" title="End Quiz"><i data-lucide="stop-circle" class="h-4 w-4"></i></button>` : ''}
                            <button data-quiz-id="${quiz.id}" class="delete-quiz-btn p-2 hover:bg-zinc-700 rounded-md text-red-400" title="Delete Quiz"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                container.appendChild(table);
                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load quizzes for management:', error);
                document.getElementById('manage-quizzes-container').innerHTML = '<p class="text-red-400 p-8 text-center">Error loading quizzes.</p>';
            }
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/leaderboard`);
                if (!response.ok) throw new Error('Could not fetch leaderboard.');
                const leaderboardData = await response.json();
                
                const container = document.getElementById('leaderboard-container');
                container.innerHTML = '';

                if (leaderboardData.length === 0) {
                     container.innerHTML = '<p class="text-zinc-400 text-center">No scores on the leaderboard yet.</p>';
                } else {
                    const list = document.createElement('ul');
                    list.className = 'space-y-4';
                    leaderboardData.forEach((player, index) => {
                        const rankIcons = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                        const rank = index < 3 ? `<span class="text-2xl mr-4">${rankIcons[index]}</span>` : `<span class="font-bold text-zinc-400 w-8 text-center mr-4">${index + 1}</span>`;
                        
                        const item = document.createElement('li');
                        item.className = 'flex items-center';
                        item.innerHTML = `
                            ${rank}
                            <img src="https://i.pravatar.cc/32?u=${player.studentId}" class="h-8 w-8 rounded-full mr-3" alt="">
                            <div class="flex-grow"><p class="font-semibold text-white">${player.name}</p></div>
                            <span class="font-bold text-green-400">${player.points} pts</span>
                        `;
                        list.appendChild(item);
                    });
                    container.appendChild(list);
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
                document.getElementById('leaderboard-container').innerHTML = '<p class="text-red-400">Could not load leaderboard.</p>';
            }
        }


        // ===================================
        // EVENT LISTENERS & UI LOGIC
        // ===================================
        const navLinks = document.querySelectorAll('aside nav a, aside .sidebar-footer a');
        const pageSections = document.querySelectorAll('.page-section');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPageId = link.getAttribute('data-page');
                document.querySelector('aside li.active')?.classList.remove('active');
                link.closest('li').classList.add('active');
                pageSections.forEach(section => {
                    section.classList.toggle('active', section.id === targetPageId);
                });
            });
        });

        // Event delegation for managing quizzes
        document.getElementById('manage-quizzes-container').addEventListener('click', async (e) => {
            const endBtn = e.target.closest('.end-quiz-btn');
            const deleteBtn = e.target.closest('.delete-quiz-btn');

            if (endBtn) {
                const quizId = endBtn.dataset.quizId;
                if (confirm('Are you sure you want to end this quiz? This cannot be undone.')) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}/end`, { method: 'PATCH' });
                        if (!response.ok) throw new Error('Failed to end quiz.');
                        alert('Quiz ended successfully.');
                        loadManageableQuizzes(); // Refresh the list
                    } catch (error) {
                        console.error(error);
                        alert('Could not end the quiz.');
                    }
                }
            }
            if (deleteBtn) {
                const quizId = deleteBtn.dataset.quizId;
                if (confirm('Are you sure you want to permanently delete this quiz? This will remove all associated results and cannot be undone.')) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/quizzes/${quizId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete quiz.');
                        alert('Quiz deleted successfully.');
                        loadManageableQuizzes(); // Refresh the list
                        loadLeaderboard(); // Refresh leaderboard as scores might change
                    } catch (error) {
                        console.error(error);
                        alert('Could not delete the quiz.');
                    }
                }
            }
        });

        // QUIZ CREATION MODAL LOGIC
        const quizModal = document.getElementById('quiz-modal'), newQuizBtn = document.getElementById('new-quiz-btn'), closeQuizBtn = document.getElementById('close-quiz-modal'), quizForm = document.getElementById('quiz-form');
        const prevBtn = document.getElementById('wizard-prev-btn'), nextBtn = document.getElementById('wizard-next-btn'), submitBtn = document.getElementById('wizard-submit-btn'), steps = document.querySelectorAll('.wizard-step'), stepIndicator = document.getElementById('wizard-step-indicator');
        let currentStep = 0;
        const stepInfo = ["Step 1: Quiz Details", "Step 2: Add Questions", "Step 3: Review & Save"];

        function updateWizardView() {
            steps.forEach((step, index) => step.classList.toggle('hidden', index !== currentStep));
            stepIndicator.textContent = stepInfo[currentStep];
            prevBtn.classList.toggle('hidden', currentStep === 0);
            nextBtn.classList.toggle('hidden', currentStep === steps.length - 1);
            submitBtn.classList.toggle('hidden', currentStep !== steps.length - 1);
        }
    
        nextBtn.addEventListener('click', () => { if (currentStep < steps.length - 1) { currentStep++; if (currentStep === 2) generateQuizReview(); updateWizardView(); } });
        prevBtn.addEventListener('click', () => { if (currentStep > 0) { currentStep--; updateWizardView(); } });

        const openModal = () => { quizModal.classList.remove('hidden'); currentStep = 0; quizForm.reset(); document.getElementById('questions-container').innerHTML = ''; questionCounter = 0; updateQuestionUI(); updateWizardView(); };
        const closeModal = () => quizModal.classList.add('hidden');
        newQuizBtn.addEventListener('click', openModal);
        closeQuizBtn.addEventListener('click', closeModal);

        function generateQuizReview() {
            const title = document.getElementById('quiz-title').value || 'N/A';
            const subject = document.getElementById('quiz-subject').value || 'N/A';
            const questionCount = document.getElementById('questions-container').children.length;
            const startTime = document.getElementById('quiz-start-time').value;
            const endTime = document.getElementById('quiz-end-time').value;
            document.getElementById('quiz-review-area').innerHTML = `<div class="space-y-2 text-sm"><p><strong>Title:</strong> ${title}</p><p><strong>Subject:</strong> ${subject}</p><p><strong>Questions:</strong> ${questionCount}</p><p><strong>Starts:</strong> ${startTime || 'Immediately'}</p><p><strong>Ends:</strong> ${endTime || 'Never'}</p></div>`;
        }

        const addQuestionBtn = document.getElementById('add-question-btn'), questionsContainer = document.getElementById('questions-container'), noQuestionsDiv = document.getElementById('no-questions');
        let questionCounter = 0;

        const updateQuestionUI = () => {
            const items = questionsContainer.querySelectorAll('.question-item');
            noQuestionsDiv.classList.toggle('hidden', items.length > 0);
            items.forEach((item, index) => {
                item.querySelector('.question-number').textContent = `Q${index + 1}`;
            });
        };

        addQuestionBtn.addEventListener('click', () => {
            questionCounter++;
            const qDiv = document.createElement('div');
            qDiv.className = 'question-item p-4 border rounded-lg bg-zinc-50 fade-in-up';
            qDiv.innerHTML = `<div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-zinc-700 flex items-center"><span class="question-number w-8 h-8 flex items-center justify-center bg-purple-100 text-purple-600 rounded-md font-semibold mr-3"></span>Question Text</h4>
                                <div class="flex items-center">
                                    <label class="text-xs font-medium text-zinc-600 mr-2">Points</label>
                                    <input type="number" name="question_${questionCounter}_points" value="1" min="1" class="w-16 border-zinc-300 rounded-md text-sm">
                                    <button type="button" class="delete-question p-1 text-zinc-400 hover:text-red-500 ml-2"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                                </div>
                              </div>
                              <textarea name="question_${questionCounter}_text" required class="w-full border-zinc-300 rounded-lg text-sm" placeholder="e.g., What is the capital of France?"></textarea>
                              <div class="mt-3 space-y-2">
                                ${[1,2,3,4].map(i => `<div class="flex items-center"><input type="radio" name="correct_answer_${questionCounter}" value="${i-1}" required class="mr-2 focus:ring-purple-500"><input type="text" name="question_${questionCounter}_option_${i}" required class="w-full border-zinc-300 rounded-md text-sm" placeholder="Option ${i}"></div>`).join('')}
                              </div>`;
            questionsContainer.appendChild(qDiv);
            qDiv.querySelector('.delete-question').addEventListener('click', () => { qDiv.remove(); updateQuestionUI(); });
            lucide.createIcons();
            updateQuestionUI();
        });
        
            quizForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(quizForm);
                const quizData = {
                    title: formData.get('title'),
                    subject: formData.get('subject'),
                    startTime: formData.get('startTime') || null,
                    endTime: formData.get('endTime') || null,
                    teacherId: teacherId,  // Add teacherId from localStorage here
                    questions: []
                };
                const questionItems = questionsContainer.querySelectorAll('.question-item');
                questionItems.forEach((item, index) => {
                    const qNum = item.querySelector('textarea').name.split('_')[1];
                    const question = {
                        text: formData.get(`question_${qNum}_text`),
                        options: [
                            formData.get(`question_${qNum}_option_1`),
                            formData.get(`question_${qNum}_option_2`),
                            formData.get(`question_${qNum}_option_3`),
                            formData.get(`question_${qNum}_option_4`),
                        ].filter(opt => opt && opt.trim() !== ''),
                        correctAnswerIndex: parseInt(formData.get(`correct_answer_${qNum}`)),
                        points: parseInt(formData.get(`question_${qNum}_points`)) || 1
                    };
                    quizData.questions.push(question);
                });
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/quizzes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(quizData)
                    });
                    if (!response.ok) throw new Error('Server failed to create quiz.');
                    alert('Quiz created successfully!');
                    closeModal();
                    loadManageableQuizzes(); // Refresh the list
                } catch (error) {
                    console.error("Failed to submit quiz:", error);
                    alert('Error: Could not create quiz.');
                }
            });

        // Load initial data for the dashboard
        loadInitialData();

        // VIDEO UPLOAD MODAL LOGIC
        const videoUploadModal = document.getElementById('video-upload-modal');
        const uploadVideoBtn = document.getElementById('upload-video-btn');
        const closeVideoBtn = document.getElementById('close-video-modal');
        const videoUploadForm = document.getElementById('video-upload-form');

        uploadVideoBtn.addEventListener('click', () => {
            videoUploadModal.classList.remove('hidden');
        });

        closeVideoBtn.addEventListener('click', () => {
            videoUploadModal.classList.add('hidden');
        });

        videoUploadForm.addEventListener('submit', async (e) => {
            console.log('Video upload form submit event triggered');
            e.preventDefault();
            const formData = new FormData(videoUploadForm);

            // Log FormData keys and values for debugging
            console.log('FormData entries:');
            for (const pair of formData.entries()) {
                console.log(`${pair[0]}:`, pair[1]);
            }

            // Validate video file input
            const videoFileInput = document.getElementById('video-file');
            if (!videoFileInput.files || videoFileInput.files.length === 0) {
                alert('Please select a video file to upload.');
                return;
            }

            // Get teacher data from the loaded teacherData
            const teacherResponse = await fetch(`${API_BASE_URL}/api/teachers/${teacherId}`);
            if (!teacherResponse.ok) {
                console.error('Failed to fetch teacher data:', teacherResponse.statusText);
                alert('Failed to retrieve teacher information. Please try again.');
                return;
            }
            const teacherData = await teacherResponse.json();

            // Append teacher data to formData
            formData.append('teacherName', teacherData.name);
            formData.append('subject', teacherData.subject);

            try {
                const response = await fetch(`${API_BASE_URL}/api/videos/upload`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to upload video.');
                const result = await response.json();
                alert('Video uploaded successfully!');
                videoUploadForm.reset();
                videoUploadModal.classList.add('hidden');
            } catch (error) {
                console.error('Video upload error:', error);
                alert('Failed to upload video. Please try again.');
            }
        });

        // NOTES UPLOAD MODAL LOGIC
        const notesUploadModal = document.getElementById('notes-upload-modal');
        const addNotesBtn = document.getElementById('add-notes-btn');
        const closeNotesBtn = document.getElementById('close-notes-modal');
        const notesUploadForm = document.getElementById('notes-upload-form');

        addNotesBtn.addEventListener('click', () => {
            notesUploadModal.classList.remove('hidden');
        });

        closeNotesBtn.addEventListener('click', () => {
            notesUploadModal.classList.add('hidden');
        });

        notesUploadForm.addEventListener('submit', async (e) => {
            console.log('Notes upload form submit event triggered');
            e.preventDefault();
            const formData = new FormData(notesUploadForm);

            // Log FormData keys and values for debugging
            console.log('FormData entries:');
            for (const pair of formData.entries()) {
                console.log(`${pair[0]}:`, pair[1]);
            }

            // Validate notes file input
            const notesFileInput = document.getElementById('notes-file');
            if (!notesFileInput.files || notesFileInput.files.length === 0) {
                alert('Please select a notes file to upload.');
                return;
            }

            // Get teacher data from the loaded teacherData
            const teacherResponse = await fetch(`${API_BASE_URL}/api/teachers/${teacherId}`);
            if (!teacherResponse.ok) {
                console.error('Failed to fetch teacher data:', teacherResponse.statusText);
                alert('Failed to retrieve teacher information. Please try again.');
                return;
            }
            const teacherData = await teacherResponse.json();

            // Append teacher data to formData
            formData.append('teacherName', teacherData.name);
            formData.append('subject', teacherData.subject);

            try {
                const response = await fetch(`${API_BASE_URL}/api/notes/upload`, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to upload notes.');
                const result = await response.json();
                alert('Notes uploaded successfully!');
                notesUploadForm.reset();
                notesUploadModal.classList.add('hidden');
            } catch (error) {
                console.error('Notes upload error:', error);
                alert('Failed to upload notes. Please try again.');
            }
        });

        // LIVE LECTURE MODAL LOGIC
        const liveLectureModal = document.getElementById('live-lecture-modal');
        const startLiveBtn = document.getElementById('start-live-btn');
        const closeLiveBtn = document.getElementById('close-live-modal');
        const liveLectureForm = document.getElementById('live-lecture-form');

        startLiveBtn.addEventListener('click', () => {
            liveLectureModal.classList.remove('hidden');
        });

        closeLiveBtn.addEventListener('click', () => {
            liveLectureModal.classList.add('hidden');
        });

        liveLectureForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(liveLectureForm);
            const topic = formData.get('topic');

            try {
                const response = await fetch(`${API_BASE_URL}/api/live/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teacherId: parseInt(teacherId), topic })
                });
                if (!response.ok) throw new Error('Failed to start live lecture.');
                const result = await response.json();
                alert('Live lecture started successfully!');
                liveLectureForm.reset();
                liveLectureModal.classList.add('hidden');
            } catch (error) {
                console.error('Live lecture start error:', error);
                alert('Failed to start live lecture. Please try again.');
            }
        });
    });
</script>
</body>
</html>

